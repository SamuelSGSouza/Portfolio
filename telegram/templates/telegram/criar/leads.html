{% extends 'base.html' %}
{% load static %}

{% block content %}
 <div class="layout-wrapper layout-content-navbar">
  <div class="layout-container">
    

    <!-- Layout container -->
    <div class="layout-page">
      <!-- Navbar -->

      {% include 'parcials/_aside_menu.html' %}
      {% include 'parcials/_navbar.html' %}

      <!-- / Navbar -->

      <!-- Content wrapper -->
      <div class="content-wrapper">
        <!-- Content -->

        <div class="container-xxl flex-grow-1 container-p-y">
          <div class="row">
            <div class="col-lg-12 mb-4 order-0">
              <div class="card">
                <div class="d-flex align-items-end row">
                  <div class="col-sm-7">
                    <div class="card-body">
                      <h5 class="card-title text-primary">Entenda Melhor os Leads! <i class="menu-icon tf-icons bx bxl-telegram"></i></h5>
                      <p class="mb-4">
                        Leads são um conjunto de mensagens que serão enviadas nos horários
                        determinados por você. Porém, para criar os leads existem algumas regras e
                        limitações que você deve seguir. Clique no botão abaixo para saber mais.
                        
                        </p>
                        <button
                          type="button"
                          class="btn btn-primary"
                          data-bs-toggle="modal"
                          data-bs-target="#modalScrollable"
                        >
                          Saiba Mais
                        </button>

                    </div>
                  </div>
                  <div class="col-sm-5 text-center text-sm-left">
                    <div class="card-body pb-0 px-0 px-md-4">
                      <img
                        src="{% static 'assets/img/illustrations/man-with-laptop-light.png' %}"
                        height="140"
                        alt="View Badge User"
                        data-app-dark-img="illustrations/man-with-laptop-dark.png"
                        data-app-light-img="illustrations/man-with-laptop-light.png"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>


            <div class="col-xxl">
              <div class="card mb-4">
                <div class="card-header d-flex align-items-center justify-content-between">
                  <h5 class="mb-0">Criar Novo Lead</h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-12 mb-3">
                      <!-- Input nome do Lead -->
                      <div>
                        <label for="defaultFormControlInput" class="form-label">Nome do Lead</label>
                        <input
                          type="text"
                          class="form-control"
                          id="defaultFormControlInput"
                          placeholder="John Doe"
                          aria-describedby="defaultFormControlHelp"
                          id="titulo-lead"
                          oninput="window.horarios['titulo'] = this.value;"
                        />
                      </div>
                      <div class="my-4">
                      <div class="my-4">
                        <label for="controlToken" class="form-label">Token do Bot</label>
                        <input
                          type="text"
                          class="form-control"
                          id="controlToken"
                          placeholder="6939028009:AAEce6UiBT_Xn99AS9BTge2HCp2m6AfpK4"
                          aria-describedby="defaultFormControlHelp"
                          id="titulo-lead"
                          oninput="window.horarios['token_bot'] = this.value;"
                        />
                        <small>Caso não saiba o token do seu bot, clique <a href="https://t.me/BotFather" target="_blank" class="text-primary">aqui</a> para saber como conseguir.</small>
                      </div>
                      <div >
                        <label for="controlChat" class="form-label">Token do Chat</label>
                        <input
                          type="text"
                          class="form-control"
                          id="controlChat"
                          placeholder="-1002124781237"
                          aria-describedby="defaultFormControlHelp"
                          id="titulo-lead"
                          oninput="window.horarios['token_chat'] = this.value;"
                        />
                        <small>Caso não saiba o token do seu bot, clique <a href="https://t.me/BotFather" target="_blank" class="text-primary">aqui</a> para saber como conseguir.</small>
                      </div>
                    </div>
                  </div>
                  <div id="horarios-wrap">
            
                  </div>
                  <button class="btn btn-outline-primary btn-time mb-3" id="btn-add-horario"
                  data-bs-toggle="modal"
                  data-bs-target="#modalTimeSelect">
                    Adicionar Horário
                  </button>
              </div>
              </div>

              <!--BOtão de salvar o lead-->
              <div class="row">
                <div class="col-12">
                  <button class="btn btn-primary d-block mx-auto mb-3" id="btn-save-lead" onclick="saveLead()">
                    Salvar Lead
                  </button>
                </div>
              </div>
            </div>



            </div>
        </div>
        <!-- / Content -->

        {% include 'parcials/_footer.html' %}

        <div class="content-backdrop fade"></div>
      </div>
      <!-- Content wrapper -->
    </div>
    <!-- / Layout page -->
  </div>

  <!-- Overlay -->
  <div class="layout-overlay layout-menu-toggle"></div>
</div>
<div class="modal fade" id="modalScrollable" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalScrollableTitle">Regras e Instruções Para os Leads</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body text-black">
        <p class="text-primary">Regras:</p>
          <p class="ml-2">Lead é um conjunto de mensagens que serão enviadas nos horários determinados por você.</p>
          <p class="ml-2">Para cada lead criado, será cobrado o valor de R$ 50 por mês, independente da quantidade de uso.
            O valor deverá ser pago para liberar a criação de leads.
          </p>
          <p class="ml-2">Os leads são pagos por mês, ou seja, se você criar um lead no dia 15 de um mês, ele será cobrado até o dia 15 do mês seguinte.
            Caso você não pague o valor do lead, ele será excluído, ele será inicialmente desativado e após 7 dias será excluído.
          </p>
          <p class="ml-2">Cada lead pode ter no máximo 15 mensagens, caso você tente adicionar uma mensagem em um lead que já tenha 15 mensagens, você não conseguirá adicionar a mensagem.</p>
          <p class="ml-2">Criações e exclusões de leads podem demorar até 20 minutos para serem processadas</p>
          <p class="ml-2">Mensagens no mesmo horário serão enviadas em ordem de Nome da Mensagem</p>
          <p class="ml-2">Os horários podem sofrer pequenos atrasos de até 5 minutos</p>
          <p class="ml-2">O horário de envio é de 00:00 até 23:55</p>
          
          <p class="text-primary">Instruções:</p>
          <p class="ml-2">-Clique no botão "Adicionar Mensagem" para adicionar uma mensagem</p>
          <p class="ml-2">-Clique no botão "Adicionar Horário" para adicionar um horário</p>
          <p class="ml-2">-Clique no botão "Remover Mensagem" para remover uma mensagem</p>
          <p class="ml-2">-Clique no botão "Adicionar Mensagem" para adicionar uma mensagem</p>
          
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Fechar
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalTimeSelect" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="">Selecione o Horário</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body text-black">
        <select id="hora_selecionada" class="form-select form-select-lg">
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Fechar
        </button>
        <button type="button" class="btn btn-outline-primary" id="btn-add-time" id="btn-confirmar-hora" onclick="addTime()">
          Adicionar
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="modalMensagemSelect" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="">Selecione A Mensagem</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body text-black">
        <select id="mensagem_selecionada" class="form-select form-select-lg">
          {% for mensagem in mensagens %}
            <option value="{{ mensagem.id }}">{{ mensagem.titulo }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Fechar
        </button>
        <button type="button" class="btn btn-outline-primary" id="btn-add-time" id="btn-confirmar-mensagem" onclick="addMensagem()">
          Adicionar
        </button>
      </div>
    </div>
  </div>
</div>
<script>
  //adicionando no hora_selecionada horarios de 00:00 até 23:55 de 5 em 5 minutos
  var hora_selecionada = document.getElementById("hora_selecionada");
  for(var i = 0; i < 24; i++){
    if (i < 10){
      i = "0" + i;
    };
    for(var j = 0; j < 60; j+=5){
      var l = j;
      if (j < 10){
        l = "0" + j;
      };
      var option = document.createElement("option");
      option.value = i + ":" + l;
      option.innerHTML = i + ":" + l;
      hora_selecionada.appendChild(option);
    }
  }

  //criando um dicionario como variavel global
  window.horarios = {};
  //quando o botão de confirmar hora for clicado algumas coisas devem acontecer:
  //1 - pegar o valor do horario selecionado e adicionar no dicionario
  //2 - limpar o select de horarios
  //3 - adicionar uma div com o horario selecionado dentro de horarios-wrap
  //4 - adicionar botão de "adicionar mensagem" dentro da div criada
  //4 - adicionar um botão de remover horario dentro da div criada
  //5 - adicionar um evento de click no botão de remover horario
  //6 - quando o botão de remover horario for clicado, remover a div do horario selecionado
  
  function addTime(){
    //fechando o modal
    var modal = bootstrap.Modal.getInstance(document.getElementById("modalTimeSelect"));
    modal.hide();
    var hora_selecionada = document.getElementById("hora_selecionada");
    var hora = hora_selecionada.options[hora_selecionada.selectedIndex].value;
    var horarios_wrap = document.getElementById("horarios-wrap");
    var div = document.createElement("div");
    div.classList.add("card");
    div.classList.add("mb-4");
    div.classList.add("time-card");
    div.innerHTML = `
      <div class="horario container-fluid">
        <div class="d-flex horario-header" >
          <div class="flex-grow-1">
            <h5 class="text-center">Horário ${hora}:00</h5>
          </div>
          <div class="">
            <i class="menu-icon tf-icons bx bx-trash text-danger mt-1 icon-rmv" data-hora="${hora}" onclick="removeTime(this)"></i>
          </div>
        </div>
        <div class="row my-2">
          <div class="col-12 mensagens-wrap" data-hora="${hora}">
          </div>
        </div>

        <div class="row">
          <div class="col-12">
            <button class="btn btn-primary d-block mx-auto mb-3" id="btn-add-message"
            data-bs-toggle="modal"
            data-bs-target="#modalMensagemSelect"
            data-hora="${hora}"
            onclick="mudaHorarioFoco(this)">
              Adicionar Mensagem
            </button>
          </div>
      </div>`;

    //adicionando div com horario selecionado dentro de horarios-wrap
    horarios_wrap.appendChild(div);

    window.horarios[hora] = []
    
  }
  function mudaHorarioFoco(button){
    var hora = button.getAttribute("data-hora");
    window.horario_foco = hora;
  }
    
  function removeTime(button){
    var card = button.parentElement.parentElement.parentElement.parentElement;
    var hora = button.getAttribute("data-hora");
    delete window.horarios[hora];
    card.remove();
  }

  function addMensagem(){
    
    //pegando a hora do elemento pai
    var hora = window.horario_foco;

    //fechando o modal
    var modal = bootstrap.Modal.getInstance(document.getElementById("modalMensagemSelect"));
    modal.hide();
    var mensagem_selecionada = document.getElementById("mensagem_selecionada");
    var mensagem = mensagem_selecionada.options[mensagem_selecionada.selectedIndex].value;
    var mensagens_wrap = document.querySelector(`.mensagens-wrap[data-hora="${hora}"]`);
    var div = document.createElement("div");
    div.classList.add("card");
    div.classList.add("mb-4");
    div.classList.add("mensagem-card");
    div.innerHTML = `
      <div class="mensagem container-fluid">
        <div class="d-flex mensagem-header" >
          <div class="flex-grow-1">
            <h5 class="text-center">Mensagem ${mensagem}</h5>
          </div>
          <div class="">
            <i class="menu-icon tf-icons bx bx-trash text-danger mt-1 icon-rmv" data-hora="${hora}" data-id_message="${mensagem}" onclick="removeMensagem(this)"></i>
          </div>
        </div>
      </div>`;

    //adicionando div com horario selecionado dentro de horarios-wrap
    mensagens_wrap.appendChild(div);

    window.horarios[hora].push(mensagem);
  }

  function removeMensagem(button){
    var card = button.parentElement.parentElement.parentElement.parentElement;
    card.remove();

    var mensagem = button.getAttribute("data-id_message");
    var hora = button.getAttribute("data-hora");
    var index = window.horarios[hora].indexOf(mensagem);
    if (index > -1) {
      window.horarios[hora].splice(index, 1);
    }

  }

  function saveLead(){
    //enviando os horarios para o servidor
    var horarios = window.horarios;
    $.ajax({
      type: "POST",
      url: "{% url 'telegram_create_lead' %}",
      data: {
        'horarios': JSON.stringify(horarios),
        'csrfmiddlewaretoken': '{{ csrf_token }}'
      },
      success: function (data) {
        console.log(data);
        if (data.status){
          window.location.href = "{% url 'telegram_leads' %}";
        }
      },
      error: function (data) {
        console.log(data);
      }
    });
  }
  //quando "titulo-lead" for alterado, alterar o nome do lead no dicionario
  var nome_lead = document.getElementById("titulo-lead");
  nome_lead.addEventListener("change", function(){
    window.horarios["titulo"] = nome_lead.value;
  });
</script>
{% endblock %}